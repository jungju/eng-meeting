<script>import{onMount}from'svelte';let info=[],en=[],ko=[],sel='',base='',pre='',aud,mode='',pIdx=null,sc={c:0,t:0},q=null,last=null,koOn=!1;const hd=["Present","Past","Future","Present Progressive","Past Progressive","Future Progressive","Present Perfect","Past Perfect","Future Perfect"],sb=["I","You","He","We","They"],req=async u=>(await fetch(u)).ok?await(await fetch(u)).json():[];onMount(async()=>{info=await req('/assets/tense/info.json');await ld('sentences1-1.json','eat')});async function ld(f,l){const e=await req(`/assets/tense/${f}`);if(!e.length)return alert(`fail ${f}`);ko=await req(`/assets/tense/${f.replace('-1.json','-2.json')}`);en=e;sel=f;base=l;pre=f.replace('sentences','').replace('.json','');aud?.pause();pIdx=null;mode='';sc={c:0,t:0};q=null;last=null;koOn=!1}const row=i=>(koOn&&ko.length?ko:en).slice(i*9,i*9+9),play=i=>{if(mode||!pre.endsWith('-1'))return;aud?.pause();aud=new Audio(`/assets/tense/audio/${pre}-${i+1}.mp3`);pIdx=i;aud.onended=()=>pIdx=null;aud.play().catch(()=>{})},blank=()=>{mode='blank';last=null},guess=()=>{if(mode==='guess'){aud?.pause();aud&&(aud.currentTime=0,aud.play().catch(()=>{}));return;}koOn=!1;mode='guess';sc={c:0,t:0};nx()},nx=()=>{last=null;const v=Math.floor(Math.random()*5)+1,gp=Math.floor(Math.random()*2)+1,i=Math.floor(Math.random()*45)+1;q=i-1;sc.t++;aud?.pause();aud=new Audio(`/assets/tense/audio/${v}-${gp}-${i}.mp3`);aud.play().catch(()=>{})},chk=(i,j)=>{if(mode!=='guess'||q===null)return;const ok=i===Math.floor(q/9)&&j===q%9;if(ok)sc.c++;last={r:i,c:j,x:ok};setTimeout(nx,500)},blankify=s=>{const p=s.replace(/\.$/,'').split(' ');return p.length<3?s:`${p[0]} ${p.slice(1,-1).map(w=>'_'.repeat(w.length)).join(' ')} ${p[p.length-1]}`}</script><style>table{border-collapse:collapse;width:100%;min-width:800px;margin-bottom:80px}th,td{border:1px solid #ccc;padding:8px;text-align:center}th{background:#333;color:#fff}td:first-child{background:#333;color:#fff;font-weight:600}td.click{cursor:pointer}td.play{background:#fffae6}td.blank{background:#fafafa}td.ok{background:#2a9d8f;color:#000}td.no{background:#d9534f;color:#fff}.footer{position:fixed;bottom:0;left:0;right:0;background:#222;padding:8px 16px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;z-index:100}.footer button{width:100px;background:#444;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer}.footer button.active{background:#2a9d8f;color:#000}.footer button:disabled{opacity:.4;cursor:not-allowed}</style>{#if en.length}<div style="overflow-x:auto"><table><thead><tr><th>Subject</th>{#each hd as h}<th>{h}</th>{/each}</tr></thead><tbody>{#each sb as s,i}<tr><td>{s}</td>{#each row(i) as c,j}<td class:click={!mode&&pre.endsWith('-1')} class:play={!mode&&pIdx===i*9+j} class:blank={mode==='blank'} class:ok={mode==='guess'&&last?.x&&last.r===i&&last.c===j} class:no={mode==='guess'&&last&&last.x===!1&&last.r===i&&last.c===j} on:click={()=>{if(!mode)play(i*9+j);else if(mode==='guess')chk(i,j)}}>{mode==='blank'?blankify(c):mode==='guess'?'?':c}</td>{/each}</tr>{/each}</tbody></table></div>{:else}<p style="margin-bottom:80px;">⬇ 하단 버튼을 눌러 문장을 불러오세요.</p>{/if}<div class="footer"><div class="left-controls"><button on:click={()=>sel.startsWith('tense_info1')?ld('tense_info2.json','Tense Info 2'):ld('tense_info1.json','Tense Info 1')} class:active={sel.startsWith('tense_info')}>Info</button></div><div class="mid-controls" style="display:flex;gap:8px;align-items:center">{#each info as it}<button on:click={()=>ld(it.file_en,it.base)} class:active={!mode&&sel===it.file_en}>{it.base}</button>{/each}</div><div class="right-controls" style="display:flex;gap:8px;align-items:center"><button on:click={()=>koOn=!koOn} class:active={koOn} disabled={!ko.length||sel.startsWith('tense_info')||mode}>한글</button><button on:click={blank} class:active={mode==='blank'} disabled={sel.startsWith('tense_info')}>Blank</button><button on:click={guess} class:active={mode==='guess'}>{mode==='guess'?`${sc.c}/${sc.t}`:'Tense Quiz'}</button></div></div>
